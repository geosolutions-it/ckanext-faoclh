{% ckan_extends %}

{% block form %}
  {% set facets = {
    'fields': c.fields_grouped,
    'search': c.search_facets,
    'titles': c.facet_titles,
    'translated_fields': c.translated_fields,
    'remove_field': c.remove_field }
  %}
  {% set sorting = [
    (_('Relevance'), 'score desc, metadata_modified desc'),
    (_('Name Ascending'), 'title_string asc'),
    (_('Name Descending'), 'title_string desc'),
    (_('Last Modified'), 'metadata_modified desc'),
    (_('Language Ascending'), 'language asc'),
    (_('Language Descending'), 'language desc'),
    (_('Popular'), 'views_recent desc') if g.tracking_enabled else (false, false) ]
  %}
  {% snippet 'snippets/search_form.html', type='dataset', query=c.q, sorting=sorting, sorting_selected=c.sort_by_selected, count=c.page.item_count, facets=facets, show_empty=request.params, error=c.query_error %}
{% endblock %}

{% block secondary_content %}
<div class="filters">
  <div>
    {% for facet in c.facet_titles %}
      {% if facet  in ['fao_resource_type', 'fao_activity_type', 'fao_geographic_focus']  %}
        {{ h.snippet('snippets/facet_list.html', title=c.facet_titles[facet], name=facet, label_function=h.fao_voc_label_func(facet)) }}
      {% else %}
        {{ h.snippet('snippets/facet_list.html', title=c.facet_titles[facet], name=facet) }}
      {% endif %}
    {% endfor %}
  </div>
  <a class="close no-text hide-filters"><i class="fa fa-times-circle"></i><span class="text">close</span></a>
</div>
<script>
const fao_facet_search_key = '_fao_expanded_facets';

function update_facet_href(elements = [], open_facet_href) {
	const arrayLength = elements.length;
	for (let i = 0; i < arrayLength; i++) {
		const href_search_params = new window.URLSearchParams(elements[i].search);
		href_search_params.set(fao_facet_search_key, open_facet_href);
		elements[i].href = `?${href_search_params.toString()}`;
	}
}
async function toggle_facet_expansion_url_params(facet) {
	const params = new window.URLSearchParams(window.location.search);
	let all_facet_links = document.getElementsByClassName('fao-facet-link');
	try {
		let open_facets = [...new Set(params.get(fao_facet_search_key).split(','))];
		if (!document.getElementById(`${facet}_facet`).classList.contains('faoclh-collapsible-nav') && open_facets.includes(facet)) {
			const new_open_facets = open_facets.filter(function (item) {
				return item !== facet
			});
			params.set(fao_facet_search_key, new_open_facets.join(','));
			window.history.replaceState(null, null, `?${params.toString()}`);
			await update_facet_href(all_facet_links, params.get(fao_facet_search_key));
		} else {
			open_facets.push(facet);
			params.set(fao_facet_search_key, open_facets.join(','));
			window.history.replaceState(null, null, `?${params.toString()}`);
			await update_facet_href(all_facet_links, params.get(fao_facet_search_key));
		}
	} catch (e) {
	    // only catch TypeError that can possible arise when url does not contain the `_fao_expanded_facets` search key
		if (e instanceof TypeError) {
			params.set(fao_facet_search_key, facet);
			window.history.replaceState(null, null, `?${params.toString()}`);
			await update_facet_href(all_facet_links, params.get(fao_facet_search_key));
		} else {
			throw e;
		}
	}
}
</script>
{% endblock %}